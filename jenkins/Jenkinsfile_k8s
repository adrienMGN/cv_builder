pipeline {
    agent any

    environment {
        KUBESPRAY_DIR = "${WORKSPACE}/kubespray"
        VENV_PATH     = "${WORKSPACE}/venv_kubespray"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
                sh "rm -rf ${KUBESPRAY_DIR}"
                sh "git clone --depth 1 --branch v2.24.0 https://github.com/kubernetes-sigs/kubespray.git ${KUBESPRAY_DIR}"
            }
        }

        stage('Install Kubespray Dependencies') {
            steps {
                sh """
                    # Création du virtualenv
                    python3 -m venv ${VENV_PATH}
                    
                    # Installation des dépendances à l'intérieur du venv
                    ${VENV_PATH}/bin/pip install --upgrade pip
                    ${VENV_PATH}/bin/pip install -r ${KUBESPRAY_DIR}/requirements.txt
                """
            }
        }

        stage('Provision Kubernetes Cluster') {
            steps {
                sshagent(['k8s-nodes-ssh-key', 'master-specific-key']) {
                    // Utilisation de l'exécutable ansible-playbook du venv
                    sh """
                    ${VENV_PATH}/bin/ansible-playbook -i jenkins/hosts.ini \
                        -b --become-user=root \
                        ${KUBESPRAY_DIR}/cluster.yml \
                        -e container_manager=containerd \
                        -e kube_network_plugin=calico
                    """
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
