pipeline {
    agent any

    environment {
        KUBESPRAY_DIR = "${WORKSPACE}/kubespray"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
                // On clone Kubespray directement dans le workspace
                sh "rm -rf ${KUBESPRAY_DIR}"
                sh "git clone --depth 1 --branch v2.24.0 https://github.com/kubernetes-sigs/kubespray.git ${KUBESPRAY_DIR}"
            }
        }

        stage('Install Kubespray Dependencies') {
            steps {
                sh """
                    # Installation des dépendances Python (nécessaire pour les modules k8s d'Ansible)
                    pip install -r ${KUBESPRAY_DIR}/requirements.txt
                """
            }
        }

        stage('Provision Kubernetes Cluster') {
            steps {
                sshagent(['k8s-nodes-ssh-key', 'master-specific-key']) {
                    ansiblePlaybook(
                        // On utilise le playbook OFFICIEL de Kubespray
                        playbook: "${KUBESPRAY_DIR}/cluster.yml",
                        inventory: "${WORKSPACE}/jenkins/hosts.ini",
                        extraVars: [
                            ansible_become: true,
                            // On force l'usage de Docker ou Containerd (Containerd est recommandé)
                            container_manager: 'containerd',
                            // On peut choisir le plugin réseau (calico, flannel, etc.)
                            kube_network_plugin: 'calico'
                        ],
                        installation: 'ansible-default',
                        colorized: true
                    )
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
