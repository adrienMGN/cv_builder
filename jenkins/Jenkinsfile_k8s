pipeline {
    agent any

    stages {
        stage('Checkout Code') {
            steps {
                // Récupère vos playbooks et fichiers d'inventaire depuis Git
                checkout scm
            }
        }

        stage('Install Ansible Dependencies') {
            steps {
                sh '''
                    # Optionnel : Installation des dépendances si vous utilisez Kubespray
                # ansible-galaxy collection install -r requirements.yml
                echo "Pas de dépendances à installer pour l'instant"
                '''
            }
        }

        stage('Provision Kubernetes Cluster') {
            steps {
                // Jenkins charge les deux clés dans l'agent SSH en mémoire
                sshagent(['k8s-nodes-ssh-key', 'master-specific-key']) {
                    ansiblePlaybook(
                        playbook: "${WORKSPACE}/jenkins/cluster.yml",
                        inventory: "${WORKSPACE}/jenkins/hosts.ini",
                        // IMPORTANT : On ne met pas de credentialsId ici car ils sont dans l'agent
                        extraVars: [
                            ansible_become: true
                        ],
                        installation: 'ansible-default',
                        colorized: true
                    )
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
