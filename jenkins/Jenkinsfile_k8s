pipeline {
    agent any

    environment {
        KUBESPRAY_DIR = "${WORKSPACE}/kubespray"
        VENV_PATH     = "${WORKSPACE}/venv_kubespray"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
                sh "rm -rf ${KUBESPRAY_DIR}"
                // ON PASSE SUR LA BRANCHE MASTER OU v2.26.0 pour compatibilité Python 3.13
                sh "git clone --depth 1 https://github.com/kubernetes-sigs/kubespray.git ${KUBESPRAY_DIR}"
            }
        }

        stage('Install Kubespray Dependencies') {
            steps {
                sh """
                    python3 -m venv ${VENV_PATH}
                    ${VENV_PATH}/bin/pip install --upgrade pip setuptools wheel
                    
                    # ASTUCE : On installe d'abord ruamel.yaml sans la partie C (clib) 
                    # ou on laisse pip essayer de trouver une version pré-compilée
                    ${VENV_PATH}/bin/pip install -r ${KUBESPRAY_DIR}/requirements.txt || ${VENV_PATH}/bin/pip install --break-system-packages -r ${KUBESPRAY_DIR}/requirements.txt
                """
            }
        }
        
        stage('Provision Kubernetes Cluster') {
            steps {
                sshagent(['k8s-nodes-ssh-key', 'master-specific-key']) {
                    sh """
                        # 1. Nettoyage VRAIMENT brutal (on vire même les dossiers de config réseau)
                        ${VENV_PATH}/bin/ansible all -i jenkins/hosts.ini -b -m shell -a "
                            rm -rf /etc/kubernetes /var/lib/kubelet /var/lib/etcd /etc/cni/net.d /usr/local/bin/kubectl /root/.kube /etc/ssl/etcd
                        "
        
                        # 2. On entre dans Kubespray
                        cd ${KUBESPRAY_DIR}
        
                        # 3. Execution avec les flags d'anti-drain
                        ${VENV_PATH}/bin/ansible-playbook -i ../jenkins/hosts.ini \
                            -b --become-user=root \
                            cluster.yml \
                            -e container_manager=containerd \
                            -e kube_network_plugin=calico \
                            -e ignore_assert_errors=yes \
                            -e skip_downloads=false \
                            -e skip_nodes_with_no_br_netfilter=true \
                            -e preinstall_selinux_state=disabled \
                            -e kubeadm_enabled=true \
                            -e "kube_override_hostname={{ inventory_hostname }}"
                    """
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
