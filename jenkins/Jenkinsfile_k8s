pipeline {
    agent any

    environment {
        // ID du credential SSH configuré dans Jenkins pour se connecter aux futurs nœuds K8s
        ANSI_SSH_CREDS = 'k8s-nodes-ssh-key'
        // Chemin vers l'inventaire Ansible (peut être un fichier dans votre repo Git)
        INVENTORY_PATH = '/var/jenkins_home/workspace/provisioning/jenkins/hosts.ini'
        //récuperation du mdp du serveur distant
    }

    stages {
        stage('Checkout Code') {
            steps {
                // Récupère vos playbooks et fichiers d'inventaire depuis Git
                checkout scm
            }
        }

        stage('Install Ansible Dependencies') {
            steps {
                sh '''
                    # Optionnel : Installation des dépendances si vous utilisez Kubespray
                # ansible-galaxy collection install -r requirements.yml
                echo "Pas de dépendances à installer pour l'instant"
                '''
            }
        }

        stage('Provision Kubernetes Cluster') {
            steps {
                // Jenkins charge les deux clés dans l'agent SSH en mémoire
                sshagent(['k8s-nodes-ssh-key', 'master-specific-key']) {
                    ansiblePlaybook(
                        playbook: "${WORKSPACE}/jenkins/cluster.yml",
                        inventory: "${WORKSPACE}/hosts.ini",
                        // IMPORTANT : On ne met pas de credentialsId ici car ils sont dans l'agent
                        extraVars: [
                            ansible_become: true
                        ],
                        installation: 'ansible-default',
                        colorized: true
                    )
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
